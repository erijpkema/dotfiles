#!/bin/bash

function sshw {
    # wait for ssh
    ssh $1
    while test $? -gt 0
    do
       sleep 5 # highly recommended - if it's in your local network, it can try an awful lot pretty quick...
       echo "Trying again..."
       ssh $1
    done
}

function reset_floating_ip {
    _fip=$(openstack server list --all-projects -f value | grep "$1" | grep -oP '\[.*?\]' | sed s/\'/\"/g  | jq '.[1]' | sed 's/\"//g')
    openstack server remove floating ip "$1" "$_fip"
    openstack server add floating ip "$1" "$_fip"
}


function search-apt-key {
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys "$1"
}

function flush-iptables {
   iptables -P INPUT ACCEPT
   iptables -P FORWARD ACCEPT
   iptables -P OUTPUT ACCEPT
   iptables -t nat -F
   iptables -t mangle -F
   iptables -F
   iptables -X
}

function stripcomment {
    grep -v '^$\|^\s*\#' "$1"
}

function checkyml {
    python -c 'import yaml,sys;yaml.safe_load(sys.stdin)' < "$1"
}

function truecryptmount {
    sudo losetup /dev/loop42 /home/egon/Dropbox/Documents/truecrypt
    sudo cryptsetup --type tcrypt open /dev/loop42 truecrypt
    mkdir -p $home/mnt
    sudo mount /dev/mapper/truecrypt  $home/mnt
}

function truecryptumount {
    sudo umount /dev/mapper/truecrypt
    sudo cryptsetup close truecrypt
    sudo losetup -d /dev/loop42
}

function bwu(){
  export BW_SESSION=$(bw unlock --raw $1)
}

function find-kolla-logs {
    keyword="$1"
    for h in merlin-managementnode001 merlin-managementnode002 merlin-managementnode003
    do
        echo -e "\e[36m$h\e[0m"
        ssh "$h" "sudo find /var/log/kolla/ -name '*.log' | xargs sudo grep $keyword"
    done
}

#alias flake8='workon flake8 && flake8 --max-line-length=119'
alias apu='sudo apt-get update && sudo apt-get dist-upgrade --yes && sudo apt-get autoremove --yes && sudo apt-get clean'
alias ctop='docker run -ti --name ctop --rm -v /var/run/docker.sock:/var/run/docker.sock quay.io/vektorlab/ctop:latest'
alias disableipv6='sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1'
alias dock_clean='docker rm $(docker ps -aq); docker rmi $(docker images --filter dangling=true)'
alias doco='docker-compose'
alias enableipv6='sudo sysctl -w net.ipv6.conf.all.disable_ipv6=0'
alias flake8='flake8 --max-line-length=119'
alias gen_mac="random |md5sum|sed 's/^\(..\)\(..\)\(..\)\(..\)\(..\).*$/02:\1:\2:\3:\4:\5/'"
alias hosts='sudo vim /etc/hosts'
alias klad='vim note:klad'
alias logs='sudo tail -f -n 0 $(find /var/log -type f)'
alias mountpi='sshfs pi:/media/disk/mp3/ /mnt/pi/ -o reconnect,ServerAliveInterval=15,ServerAliveCountMax=3'
alias nvpy='workon nvpy && nvpy'
alias o='xdg-open'
alias pep8='pep8 --max-line-length=119'
alias purge-docker='sudo service docker stop; sudo rm -rf /var/lib/docker/ ; sudo service docker start'
alias random='tr -cd '[:alnum:]' < /dev/urandom | fold -w30 | head -n1'
alias pwgen22='pwgen -y -s 22'
alias route_via_pi='sudo ip route add 0.0.0.0/1 via 172.21.42.13 dev tun0'
alias ssassoc='sacctmgr show assoc tree format=Cluster,Account,User%-30,Share,QOS%-160,DefaultQOS%-16'
alias ssinfo='sinfo -o "%P|%a|%D|%T|%z|%c|%B|%m|%d|%f|%g|%l|%s|%S|%N|%E" | column -t -s "|"'
alias ssqos='sacctmgr show qos format=Name%15,Priority,UsageFactor,GrpTRES%30,GrpSubmit,GrpJobs,MaxTRESPerUser%30,MaxSubmitJobsPerUser,MaxJobsPerUser,MaxTRESPerJob,MaxWallDurationPerJob'
alias ssqueue='squeue -o "%i|%P|%q||%j|%u|%t|%M|%R|%S|%p"  | column -t -s "|"'
alias tmux='tmux -2'
alias unnecessary-violence-to-docker='docker kill $(docker ps -q); docker rm $(docker ps -a -q) ; docker rmi -f $(docker images -q) ; docker volume rm $(docker volume ls -qf dangling=true);  sudo service docker restart'
alias vi='vim'
alias wimp='curl http://ifconfig.co/ip'
alias sxcat='sshuttle -r airlock 172.23.40.250/32 & sshuttle -r root@172.23.40.250 172.23.40.0/16'
alias sairlock='sshuttle -r airlock 172.23.40.1/25 -x 172.23.40.36'
alias yapf='PYTHONPATH=~/projects/dotfiles/_vim/bundle/yapf python3 ~/projects/dotfiles/_vim/bundle/yapf/yapf'


eval "$(thefuck --alias)"

